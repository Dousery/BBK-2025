<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas E-commerce</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .product-card:hover { transform: translateY(-2px); transition: all 0.3s ease; }
        .basket-item { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="max-w-7xl mx-auto p-5">
        <div class="bg-white rounded-lg shadow-sm p-5 mb-5 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">üõçÔ∏è Atlas E-commerce</h1>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-5">
            <!-- Product Section -->
            <div class="lg:col-span-3 bg-white rounded-lg shadow-sm p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">üõí Product Catalog</h2>
                </div>
                <div id="productsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
            </div>

            <!-- Basket Section -->
            <div class="bg-white rounded-lg shadow-sm p-5">
                <h3 class="text-lg font-bold text-gray-800 mb-4">üõí My Basket</h3>
                <div id="basketItems" class="mb-4">
                    <div class="text-gray-500 text-sm"> Basket is empty</div>
                </div>
                
                <div class="border-t pt-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">Total:</span>
                        <span class="text-xl font-bold text-blue-600" id="basketTotal">$0.00</span>
                    </div>
                    <div class="text-xs text-gray-600 mb-4">Shipping & taxes calculated at checkout</div>
                    
                    <div class="bg-gray-50 rounded p-3 mb-4 border">
                        <div class="flex justify-between items-center">
                            <span class="text-blue-600 font-bold text-sm">VISA **** 3567</span>
                        </div>
                    </div>

                    <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 disabled:bg-gray-400" 
                            id="checkoutBtn" onclick="processPayment()">
                        CHECKOUT
                    </button>
                    
                    <div id="errorMessage" class="text-red-500 text-xs mt-2 text-center hidden"></div>
                    <div id="successMessage" class="text-green-500 text-xs mt-2 text-center hidden"></div>
                </div>
            </div>
        </div>

        <!-- Notification Section -->
        <div class="bg-white rounded-lg shadow-sm p-5 mt-5">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Notifications</h3>
            <div id="notificationsList">
                <div class="bg-blue-50 rounded p-3 mb-2 border-l-4 border-green-500">
                    <div class="text-xs text-gray-600 mb-1">System Ready</div>
                    <div class="text-sm text-gray-800">All services are running and ready for shopping</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Microservice endpoints
        const PRODUCT_URL = 'http://localhost:8003';
        const BASKET_URL = 'http://localhost:8004';
        const PAYMENT_URL = 'http://localhost:8001';
        const NOTIFICATION_URL = 'http://localhost:8002';

        let currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
        let products = [];
        let basket = { items: [], total: 0 };

        // App initialization
        async function init() {
            await loadProducts();
            await loadBasket();
            startProductPolling();
        }

        async function loadProducts() {
            try {
                const response = await fetch(`${PRODUCT_URL}/products?t=${Date.now()}`, {
                    cache: 'no-cache',
                    headers: {
                        'Cache-Control': 'no-cache'
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    products = data.products;
                    displayProducts();
                } else {
                    throw new Error('Failed at loading products');
                }
            } catch (error) {
                console.error('Error at loading products:', error);
                addNotification('Failed at loading products');
            }
        }

        function displayProducts() {
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = '';

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card bg-gray-50 rounded-lg p-4 border hover:shadow-md';
                productCard.innerHTML = `
                    <div class="text-4xl mb-3 text-center">${product.image}</div>
                    <h3 class="font-bold text-gray-800 mb-2">${product.name}</h3>
                    <p class="text-sm text-gray-600 mb-2">${product.description}</p>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-lg font-bold text-blue-600">$${product.price}</span>
                        <span class="text-xs text-gray-500">Stock: ${product.stock}</span>
                    </div>
                    <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700" 
                            onclick="addToBasket('${product.id}', '${product.name}', ${product.price})">
                        Add to Basket
                    </button>
                `;
                productsList.appendChild(productCard);
            });
        }

        async function addToBasket(productId, productName, price) {
            try {
                let itemExists = false;
                for (let item of basket.items) {
                    if (item.productId === productId) {
                        item.quantity += 1;
                        itemExists = true;
                        break;
                    }
                }
                
                if (!itemExists) {
                    const tempItem = {
                        productId: productId,
                        name: productName,
                        price: price,
                        quantity: 1
                    };
                    basket.items.push(tempItem);
                }
                
                basket.total += price;
                displayBasket();
                
                // Synch with basket microservice
                const response = await fetch(`${BASKET_URL}/basket/${currentUserId}/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: productId,
                        quantity: 1
                    })
                });

                if (response.ok) {
                    const basketData = await response.json();
                    basket = basketData;
                    displayBasket();
                } else {
                    // Revert optimistic update on failure
                    const existingItem = basket.items.find(item => item.productId === productId);
                    if (existingItem) {
                        if (existingItem.quantity > 1) {
                            existingItem.quantity -= 1;
                        } else {
                            basket.items = basket.items.filter(item => item.productId !== productId);
                        }
                    }
                    basket.total -= price;
                    displayBasket();
                    throw new Error('Failed to add to basket');
                }
            } catch (error) {
                console.error('Error adding to basket:', error);
                addNotification('Failed to add to basket', 'error');
            }
        }

        // Loading user's basket
        async function loadBasket() {
            try {
                const response = await fetch(`${BASKET_URL}/basket/${currentUserId}`);
                if (response.ok) {
                    const basketData = await response.json();
                    basket = basketData;
                    displayBasket();
                }
            } catch (error) {
                console.error('Error loading basket:', error);
            }
        }

        function displayBasket() {
            const basketItems = document.getElementById('basketItems');
            const basketTotal = document.getElementById('basketTotal');

            if (basket.items.length === 0) {
                basketItems.innerHTML = '<div class="text-gray-500 text-sm">Basket is empty</div>';
                basketTotal.textContent = '$0.00';
                return;
            }

            basketItems.innerHTML = '';
            basket.items.forEach(item => {
                const basketItem = document.createElement('div');
                basketItem.className = 'basket-item bg-gray-50 rounded p-3 mb-2 flex justify-between items-center';
                basketItem.innerHTML = `
                    <div>
                        <div class="font-semibold text-sm">${item.name}</div>
                        <div class="text-xs text-gray-600">Qty: ${item.quantity}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-blue-600">$${(item.price * item.quantity).toFixed(2)}</div>
                        <button class="text-red-500 text-xs" onclick="removeFromBasket('${item.productId}')">Remove</button>
                    </div>
                `;
                basketItems.appendChild(basketItem);
            });

            basketTotal.textContent = `$${basket.total.toFixed(2)}`;
        }

        async function removeFromBasket(productId) {
            try {
                const response = await fetch(`${BASKET_URL}/basket/${currentUserId}/item/${productId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const basketData = await response.json();
                    basket = basketData;
                    displayBasket();
                }
            } catch (error) {
                console.error('Error removing from basket:', error);
                addNotification('Failed to remove item', 'error');
            }
        }

        async function processPayment() {
            const checkoutBtn = document.getElementById('checkoutBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');

            // Clearing previous messages
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';

            if (basket.items.length === 0) {
                showError('Basket is empty');
                return;
            }

            // Disable checkout button
            checkoutBtn.disabled = true;
            checkoutBtn.innerHTML = 'Processing...';

            try {
                const response = await fetch(`${PAYMENT_URL}/pay`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUserId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess(`Payment successful! Transaction ID: ${result.transactionId}`);
                    addNotification(`Payment completed for ${result.amount} ${result.currency} (User: ${result.userId})`, 'success');
                    
                    basket = { items: [], total: 0 };
                    currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
                    displayBasket();
                    loadProducts();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || 'Payment failed');
                }
            } catch (error) {
                console.error('Payment error:', error);
                showError(error.message || 'Payment failed. Please try again.');
                addNotification('Payment failed', 'error');
            } finally {
                // Re-enable checkout button
                checkoutBtn.disabled = false;
                checkoutBtn.innerHTML = 'CHECKOUT';
            }
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successMessage.classList.remove('hidden');
        }

        function addNotification(text) {
            const notificationsList = document.getElementById('notificationsList');
            const notification = document.createElement('div');
            notification.className = 'bg-blue-50 rounded p-3 mb-2 border-l-4 border-green-500';
            
            const time = new Date().toLocaleTimeString();
            notification.innerHTML = `
                <div class="text-xs text-gray-600 mb-1">${time}</div>
                <div class="text-sm text-gray-800">${text}</div>
            `;
            
            notificationsList.insertBefore(notification, notificationsList.firstChild);
            
            // Showing only last 10 notifications
            while (notificationsList.children.length > 10) {
                notificationsList.removeChild(notificationsList.lastChild);
            }
        }


        // Real-time stock monitoring with fast polling
        function startProductPolling() {
            setInterval(() => {
                loadProducts();
            }, 2000); 

            // Tracking the user's tab activity
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    loadProducts();
                }
            });
        }

        // Initializing the app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>